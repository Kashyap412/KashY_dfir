input {
  file {
    path => "C:/dfir/output/parsed_*_skadi/SRUM/*.csv"
    mode => "read"
    start_position => "beginning"
    sincedb_path => "NUL"

    file_completed_action => "log"
    file_completed_log_path => "C:/dfir/output/processed_all.log"
	#file_chunk_size => 524288

    codec => plain {
      charset => "UTF-8"
    }
  }
}



filter {

  ####################################################
  # ECS NORMALIZATION
  ####################################################
  mutate {
    copy => {
      "[event][original]" => "message"
      "[log][file][path]" => "path"
    }
    add_field => {
      "artifact_type" => "srum"
      "source_file" => "%{path}"
    }
  }

  ####################################################
  # DROP EMPTY LINES
  ####################################################
  if [message] =~ /^\s*$/ {
    drop { }
  }

  ####################################################
  # DROP CSV HEADERS (ALL SRUM FILES)
  ####################################################
  if [message] =~ /^[\uFEFF"]*Id,Timestamp,/ {
    drop { }
  }

  ####################################################
  # AppResourceUseInfo
  ####################################################
  if [path] =~ /_SrumECmd_AppResourceUseInfo_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "BackgroundBytesRead","BackgroundBytesWritten","BackgroundContextSwitches",
        "BackgroundCycleTime","BackgroundNumberOfFlushes",
        "BackgroundNumReadOperations","BackgroundNumWriteOperations",
        "FaceTime",
        "ForegroundBytesRead","ForegroundBytesWritten","ForegroundContextSwitches",
        "ForegroundCycleTime","ForegroundNumberOfFlushes",
        "ForegroundNumReadOperations","ForegroundNumWriteOperations"
      ]
    }
    mutate { add_field => { "srum_table" => "AppResourceUseInfo" } }
  }

  ####################################################
  # AppTimelineProvider
  ####################################################
  else if [path] =~ /_SrumECmd_AppTimelineProvider_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "EndTime","DurationMs"
      ]
    }
    mutate { add_field => { "srum_table" => "AppTimelineProvider" } }
  }

  ####################################################
  # EnergyUsage
  ####################################################
  else if [path] =~ /_SrumECmd_EnergyUsage_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "IsLt","ConfigurationHash","EventTimestamp","StateTransition",
        "ChargeLevel","CycleCount","DesignedCapacity","FullChargedCapacity",
        "ActiveAcTime","ActiveDcTime","ActiveDischargeTime","ActiveEnergy",
        "CsAcTime","CsDcTime","CsDischargeTime","CsEnergy"
      ]
    }
    mutate { add_field => { "srum_table" => "EnergyUsage" } }
  }

  ####################################################
  # NetworkConnections
  ####################################################
  else if [path] =~ /_SrumECmd_NetworkConnections_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "ConnectedTime","ConnectStartTime",
        "InterfaceLuid","InterfaceType",
        "L2ProfileFlags","L2ProfileId","ProfileName"
      ]
    }
    mutate { add_field => { "srum_table" => "NetworkConnections" } }
  }

  ####################################################
  # NetworkUsages
  ####################################################
  else if [path] =~ /_SrumECmd_NetworkUsages_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "BytesReceived","BytesSent",
        "InterfaceLuid","InterfaceType",
        "L2ProfileFlags","L2ProfileId","ProfileName"
      ]
    }
    mutate { add_field => { "srum_table" => "NetworkUsages" } }
  }

  ####################################################
  # PushNotifications
  ####################################################
  else if [path] =~ /_SrumECmd_PushNotifications_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName","UserId","AppId",
        "NetworkType","NotificationType","PayloadSize"
      ]
    }
    mutate { add_field => { "srum_table" => "PushNotifications" } }
  }

  ####################################################
  # vfuprov
  ####################################################
  else if [path] =~ /_SrumECmd_vfuprov_Output\.csv$/ {
    csv {
      source => "message"
      columns => [
        "Id","Timestamp","UserId","AppId",
        "ExeInfo","ExeInfoDescription","ExeTimestamp",
        "SidType","Sid","UserName",
        "StartTime","EndTime","Flags","Duration"
      ]
    }
    mutate { add_field => { "srum_table" => "vfuprov" } }
  }

  ####################################################
  # CLEANUP
  ####################################################
  mutate {
    remove_field => [
      "message",
      "[event][original]",
      "[log]",
      "host"
    ]
  }
}



output {

  elasticsearch {
    hosts => ["https://13.233.58.209:9200"]
    user => "elastic"
    password => "wsQcbfozMJF2BEnljEAq"

    ssl_enabled => true
    ssl_verification_mode => "none"

    index => "dfir-srum"
  }
}
