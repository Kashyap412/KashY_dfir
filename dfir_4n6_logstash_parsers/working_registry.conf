input {
  file {
    path => ["C:/dfir/output/parsed_*_skadi/Registry/**/*.csv", "C:/dfir/output/parsed_*_skadi/Registry/*.csv"]
    mode => "read"
    sincedb_path => "NUL"
    file_completed_action => "log"
    file_completed_log_path => "C:/dfir/output/processed_all.log"
	#file_chunk_size => 524288
    codec => plain { charset => "UTF-8" }
  }
}


filter {

  # Keep original file path
  mutate {
    add_field => { "source_file" => "%{[log][file][path]}" }
  }

  #
  # Drop CSV header lines (works for all files)
  #
  if [message] =~ /^HivePath,|^Executable,|^Extension,|^ValueName,|^Timestamp,|^BatchKeyPath/ {
    drop { }
  }

  #
  # =======================
  # RECMD â€“ User Activity
  # =======================
  if [source_file] =~ "RECmd_Batch_UserActivity_Output.csv" {
    csv {
      separator => ","
      columns => [
        "HivePath","HiveType","Description","Category","KeyPath",
        "ValueName","ValueType","ValueData","ValueData2","ValueData3",
        "Comment","Recursive","Deleted","LastWriteTimestamp","PluginDetailFile"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_user_activity" } }
  }

  #
  # CIDSizeMRU
  #
  else if [source_file] =~ "CIDSizeMRU__NTUSER.DAT.csv" {
    csv {
      separator => ","
      columns => [
        "Executable","BatchKeyPath","MRUPosition","BatchValueName","OpenedOn"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_cidsizemru" } }
  }

  #
  # FileExts
  #
  else if [source_file] =~ "FileExts__NTUSER.DAT.csv" {
    csv {
      separator => ","
      columns => [
        "Extension","BatchKeyPath","OpensWithExecutables",
        "BatchValueName","OpensWithProgramIDs","UserChoice"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_fileexts" } }
  }

  #
  # LastVisitedPidlMRU
  #
  else if [source_file] =~ "LastVisitedPidlMRU__NTUSER.DAT.csv" {
    csv {
      separator => ","
      columns => [
        "ValueName","BatchKeyPath","MruPosition","BatchValueName",
        "Executable","AbsolutePath","OpenedOn","Details"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_lastvisitedpidlmru" } }
  }

  #
  # OfficeMRU
  #
  else if [source_file] =~ "OfficeMRU__NTUSER.DAT.csv" {
    csv {
      separator => ","
      columns => [
        "ValueName","BatchKeyPath","LastOpened",
        "BatchValueName","LastClosed","FileName"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_officemru" } }
  }

  #
  # OpenSavePidlMRU
  #
  else if [source_file] =~ "OpenSavePidlMRU__NTUSER.DAT.csv" {
    csv {
      separator => ","
      columns => [
        "Extension","BatchKeyPath","ValueName","BatchValueName",
        "MruPosition","AbsolutePath","OpenedOn","Details"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_opensavepidlmru" } }
  }

  #
  # RecentDocs
  #
  else if [source_file] =~ "RecentDocs__NTUSER.DAT" {
    csv {
      separator => ","
      columns => [
        "Extension","BatchKeyPath","ValueName","BatchValueName",
        "TargetName","LnkName","MruPosition","OpenedOn","ExtensionLastOpened"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_recentdocs" } }
  }

  #
  # RunMRU
  #
  else if [source_file] =~ "RunMRU__NTUSER.DAT" {
    csv {
      separator => ","
      columns => [
        "ValueName","BatchKeyPath","MruPosition",
        "BatchValueName","Executable","OpenedOn"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_runmru" } }
  }

  #
  # Taskband
  #
  else if [source_file] =~ "Taskband__NTUSER.DAT" {
    csv {
      separator => ","
      columns => [
        "LnkName","BatchKeyPath","Executable",
        "BatchValueName","PinType"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_taskband" } }
  }

  #
  # TypedURLs
  #
  else if [source_file] =~ "TypedURLs__NTUSER.DAT" {
    csv {
      separator => ","
      columns => [
        "Timestamp","BatchKeyPath","Url","BatchValueName","Slack"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_typedurls" } }
  }

  #
  # UserAssist
  #
  else if [source_file] =~ "UserAssist__NTUSER.DAT" {
    csv {
      separator => ","
      columns => [
        "BatchKeyPath","BatchValueName","ProgramName",
        "RunCounter","FocusCount","FocusTime","LastExecuted"
      ]
    }
    mutate { add_field => { "artifact_type" => "reg_userassist" } }
  }

}
output {

  elasticsearch {
    hosts => ["https://13.233.58.209:9200"]
    user => "elastic"
    password => "wsQcbfozMJF2BEnljEAq"

    ssl_enabled => true
    ssl_verification_mode => "none"
    index => "dfir-reg"
  }
}
