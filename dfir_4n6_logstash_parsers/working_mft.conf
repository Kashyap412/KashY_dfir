########################
# INPUT
########################
input {
  file {
    path => "C:/dfir/output/parsed_*_skadi/MFT/*.csv"
    mode => "read"
    start_position => "beginning"
    sincedb_path => "NUL"
    file_completed_action => "log"
    file_completed_log_path => "C:/dfir/output/processed_all.log"
	#file_chunk_size => 524288
    codec => plain { charset => "UTF-8" }
  }
}


filter {

  #################################
  # GLOBAL CLEANUP
  #################################
  mutate {
    gsub => [
      "message", "\r", "",
      "message", "\n", ""
    ]
  }

  if [message] =~ /^\s*$/ {
    drop {}
  }

  #################################
  # DROP ZONE.IDENTIFIER ADS CONTENT
  #################################
  if [message] =~ /(ZoneTransfer|ZoneId=|ReferrerUrl=)/ {
    drop {}
  }

  #################################
  # CSV PARSING (SAFE)
  #################################
  csv {
    separator => ","
    skip_header => true
    columns => [
      "EntryNumber",
      "SequenceNumber",
      "InUse",
      "ParentEntryNumber",
      "ParentSequenceNumber",
      "ParentPath",
      "FileName",
      "Extension",
      "FileSize",
      "ReferenceCount",
      "ReparseTarget",
      "IsDirectory",
      "HasAds",
      "IsAds",
      "SI_FN",
      "uSecZeros",
      "Copied",
      "SiFlags",
      "NameType",
      "Created0x10",
      "Created0x30",
      "LastModified0x10",
      "LastModified0x30",
      "LastRecordChange0x10",
      "LastRecordChange0x30",
      "LastAccess0x10",
      "LastAccess0x30",
      "UpdateSequenceNumber",
      "LogfileSequenceNumber",
      "SecurityId",
      "ObjectIdFileDroid",
      "LoggedUtilStream",
      "ZoneIdContents",
      "SourceFile"
    ]
  }

  #################################
  # DROP BAD ROWS (CRITICAL)
  #################################
  if !([EntryNumber] =~ /^\d+$/) {
    drop {}
  }

  #################################
  # TYPE CONVERSIONS
  #################################
  mutate {
    convert => {
      "EntryNumber"            => "integer"
      "SequenceNumber"         => "integer"
      "ParentEntryNumber"      => "integer"
      "ParentSequenceNumber"   => "integer"
      "FileSize"               => "integer"
      "ReferenceCount"         => "integer"
      "UpdateSequenceNumber"   => "integer"
      "LogfileSequenceNumber"  => "integer"
      "SecurityId"             => "integer"
      "IsDirectory"            => "boolean"
      "HasAds"                 => "boolean"
      "IsAds"                  => "boolean"
      "Copied"                 => "boolean"
    }
  }

  #################################
  # PRIMARY TIMESTAMP
  #################################
  date {
    match => ["Created0x10", "yyyy-MM-dd HH:mm:ss.SSSSSS"]
    target => "@timestamp"
    timezone => "UTC"
  }

  #################################
  # ADDITIONAL TIMESTAMPS
  #################################
  date {
    match => ["Created0x30", "yyyy-MM-dd HH:mm:ss.SSSSSS"]
    target => "created_fn"
    timezone => "UTC"
  }

  date {
    match => ["LastModified0x10", "yyyy-MM-dd HH:mm:ss.SSSSSS"]
    target => "modified_si"
    timezone => "UTC"
  }

  date {
    match => ["LastModified0x30", "yyyy-MM-dd HH:mm:ss.SSSSSS"]
    target => "modified_fn"
    timezone => "UTC"
  }

  #################################
  # TIMESTOMP DETECTION
  #################################
  ruby {
    code => '
      c10 = event.get("Created0x10")
      c30 = event.get("Created0x30")
      event.set("possible_timestomp", c10 && c30 && c10 != c30)
    '
  }

  #################################
  # DELETED FILE FLAG
  #################################
  if [InUse] == "false" {
    mutate { add_field => { "deleted_file" => true } }
  } else {
    mutate { add_field => { "deleted_file" => false } }
  }

  #################################
  # ECS-LIKE NORMALIZATION
  #################################
  mutate {
    rename => {
      "FileName"    => "[file][name]"
      "Extension"   => "[file][extension]"
      "ParentPath"  => "[file][directory]"
      "FileSize"    => "[file][size]"
      "IsDirectory" => "[file][is_directory]"
      "HasAds"      => "[file][has_ads]"
      "IsAds"       => "[file][is_ads]"
    }
  }

  #################################
  # FINAL CLEANUP
  #################################
  mutate {
    strip => ["[file][name]", "[file][directory]"]
    remove_field => ["message"]
  }
}


########################
# OUTPUT
########################

output {
  elasticsearch {
    hosts => ["https://13.233.58.209:9200"]
    user => "elastic"
    password => "wsQcbfozMJF2BEnljEAq"

    ssl_enabled => true
    ssl_verification_mode => "none"
                index => "dfir-mft"
        }
}
