############################################
# INPUT
############################################
input {
  file {
    path => "C:/dfir/output/parsed_*_skadi/EventLogs/*.json"
    mode => "read"
    start_position => "beginning"
    sincedb_path => "NUL"

    file_completed_action => "log"
    file_completed_log_path => "C:/dfir/output/processed_all.log"

    codec => plain { charset => "UTF-8" }
  }
}

############################################
# FILTER
############################################
filter {

  ############################
  # Drop empty lines
  ############################
  if [message] =~ /^\s*$/ {
    drop {}
  }

  ############################
  # Parse outer EVTX JSON
  ############################
  json {
    source => "message"
    target => "evtx"
  }

  # ############################
  # # Preserve raw (ONCE)
  # ############################
  # mutate {
  #   replace => { "[event][original]" => "%{message}" }
  # }

  # ############################
  # # Promote common EVTX fields
  # ############################
  # mutate {
  #   rename => {
  #     "[evtx][ChunkNumber]"   => "chunk_number"
  #     "[evtx][Computer]"      => "computer"
  #     "[evtx][Channel]"       => "channel"
  #     "[evtx][Provider]"      => "provider"
  #     "[evtx][EventId]"       => "event_id"
  #     "[evtx][EventRecordId]" => "event_record_id"
  #     "[evtx][ProcessId]"     => "process_id"
  #     "[evtx][ThreadId]"      => "thread_id"
  #     "[evtx][Level]"         => "level"
  #     "[evtx][Keywords]"      => "keywords"
  #     "[evtx][SourceFile]"    => "source_file"
  #     "[evtx][HiddenRecord]"  => "hidden_record"
  #     "[evtx][RecordNumber]"  => "record_number"
  #     "[evtx][Payload]"       => "payload_raw"
  #     "[evtx][UserId]"        => "[user][sid]"
  #     "[evtx][UserName]"      => "[user][name]"
  #     "[evtx][TimeCreated]"   => "time_created"
  #     "[evtx][PayloadData1]"  => "[event_data][message]"
  #   }
  # }

  # ############################
  # # Parse nested Payload JSON
  # ############################
  # json {
  #   source => "payload_raw"
  #   target => "payload"
  #   skip_on_invalid_json => true
  # }

  # ############################
  # # Extract EventData
  # ############################
  # if [payload][EventData] {
  #   mutate { rename => { "[payload][EventData]" => "event_data_raw" } }
  # }

  # ############################
  # # Extract UserData
  # ############################
  # if [payload][UserData] {
  #   mutate { rename => { "[payload][UserData]" => "user_data_raw" } }
  # }

  # ############################
  # # Normalize EventData
  # ############################
  # if [event_data_raw][Data] {
  #   ruby {
  #     code => '
  #       data = event.get("[event_data_raw][Data]")
  #       if data.is_a?(Array)
  #         data.each do |e|
  #           event.set("[event_data][#{e["@Name"]}]", e["#text"]) if e["@Name"] && e["#text"]
  #         end
  #       elsif data.is_a?(String)
  #         event.set("[event_data][message]", data)
  #       end
  #     '
  #   }
  # }

  # ############################
  # # Normalize UserData (LogFileCleared etc.)
  # ############################
  # ruby {
  #   code => '
  #     ud = event.get("user_data_raw")
  #     if ud.is_a?(Hash)
  #       ud.each do |k,v|
  #         if v.is_a?(Hash)
  #           v.each { |kk,vv| event.set("[user_data][#{kk.downcase}]", vv) }
  #         end
  #       end
  #     end
  #   '
  # }

  # ############################
  # # Timestamp
  # ############################
  # date {
  #   match => ["time_created", "ISO8601"]
  #   target => "@timestamp"
  # }

  # ############################
  # # Host normalization (NO array)
  # ############################
  # mutate {
  #   replace => { "[host][name]" => "%{computer}" }
  # }

  # ############################
  # # Cleanup
  # ############################
  # mutate {
  #   remove_field => [
  #     "message",
  #     "evtx",
  #     "payload",
  #     "payload_raw",
  #     "event_data_raw",
  #     "user_data_raw",
  #     "time_created"
  #   ]
  # }
}

############################################
# OUTPUT
############################################
output {

  stdout { codec => rubydebug }

  elasticsearch {
    hosts => ["https://13.233.58.209:9200"]
    user => "elastic"
    password => "wsQcbfozMJF2BEnljEAq"

    ssl_enabled => true
    ssl_verification_mode => "none"

    index => "dfir-evtx-json"
  }
}
